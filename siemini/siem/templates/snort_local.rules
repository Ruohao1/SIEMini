# $Id: local.rules,v 1.11 2004/07/23 20:15:44 bmc Exp $
# ----------------
# LOCAL RULES
# ----------------
# This file intentionally does not come with signatures.  Put your local
# additions here.
# Détection de Brute Force SSH : 15 tentatives de connexion au port 22 en 60 secondes.
alert tcp $EXTERNAL_NET any -> $HOME_NET 22 (msg:"CUSTOM DETECT - SSH Brute Force (Rate Limit Exceeded)";content:"SSH-2.0-"; detection_filter:track by_src, count 15, seconds 60;classtype:attempted-recon; sid:9000030; rev:1;)


#Scan NMAP
#alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"CUSTOM SCAN - Nmap SYN Scan (-sS) Detected";flow:stateless; flags:S,12;classtype:attempted-recon; sid:9000050; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"CUSTOM SCAN - Nmap NULL Scan (-sN) Detected";flags:0;classtype:attempted-recon;sid:9000051; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"CUSTOM SCAN - Nmap FIN Scan (-sF) Detected";flags:F,12;classtype:attempted-recon;sid:9000052; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"CUSTOM SCAN - Nmap Xmas Scan (-sX) Detected";flags:FPU,12;classtype:attempted-recon;sid:9000053; rev:1;)

#Scann XSS
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"XSS Reflected - <script> in URI param"; flow:to_server,established; uricontent:"q=";http_uri;nocase; pcre:"/q=(?:[^&]*)\<script\b[^>]*\>/Ui"; classtype:web-application-attack; sid:100000653; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"LOCAL XSS attempt index.php id param contains literal <...> (reflected)";uricontent:"/index.php"; nocase; uricontent:"id=";http_uri; nocase;pcre:"/id\s*=\s*(?:[^&]*)(?:<[^>]{1,512}>)/Ui";classtype:web-application-attack; sid:1000006521; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"LOCAL XSS attempt index.php id param contains encoded %3C...%3E (reflected)";flow:to_server,established; uricontent:"/index.php"; nocase; uricontent:"id="; http_uri; nocase;pcre:"/id\s*=\s*(?:[^&]*)(?:%3[cC][0-9A-Fa-f]*%3[eE])/Ui";classtype:web-application-attack; sid:1000006522; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"LOCAL XSS attempt index.php id param common encodings (permissive)";uricontent:"/index.php"; nocase; uricontent:"id="; http_uri; nocase;pcre:"/id(?:=|\%3D)\s*(?:[^&]*?)(?:<|%3[cC])[^&]{1,512}(?:>|%3[eE])/Ui";classtype:web-application-attack; sid:1000006523; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"LOCAL XSS reflected in URI param - literal <...>";flow:to_server,established; uricontent:"=";http_uri; nocase;pcre:"/=[^&]{0,512}<[^>]{1,512}>/Ui";classtype:web-application-attack; sid:100000700; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"XSS POST literal <script> in body"; content:"<script"; http_client_body; nocase; classtype:web-application-attack; sid:1100003; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"XSS POST encoded %3Cscript in body"; content:"%3C"; http_client_body; nocase; pcre:"/%3[cC].*script/Ui"; classtype:web-application-attack; sid:1100004; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"XSS Modern Search - Encoded Iframe in URI/Path"; flow:to_server,established; uricontent:"%3Ciframe"; nocase; classtype:web-application-attack; sid:100000701; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"XSS Modern Search - Encoded JS ALERT in URI/Path"; flow:to_server,established; uricontent:"javascript%3aalert"; nocase; classtype:web-application-attack; sid:100000702; rev:1;)
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"ALERTE [XSS Reconnaissance]: Multiples requetes de recherche q= sur le path racine"; flow:to_server,established; uricontent:"/"; uricontent:"q="; nocase; threshold:type threshold, track by_src, count 10, seconds 60; classtype:web-application-attack; sid:100000703; rev:1;)


#Détection de Brute Force FTP
alert tcp $EXTERNAL_NET any -> $HOME_NET 21 (msg:"FTP Potential scan / SYN flood to port 21"; flags:S; threshold:type both, track by_src, count 20, seconds 60; classtype:network-scan; sid:2004001; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET 21 (msg:"FTP Multiple connection attempts (possible brute-force)"; threshold:type both, track by_src, count 10, seconds 60; classtype:attempted-recon; sid:2004002; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET 21 (msg:"FTP USER commands burst - possible brute-force"; flow:to_server,established; content:"USER "; nocase; threshold:type both, track by_src, count 8, seconds 60; classtype:attempted-admin; sid:2004003; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET 21 (msg:"FTP PASS commands burst - possible brute-force"; flow:to_server,established; content:"PASS "; nocase; threshold:type both, track by_src, count 8, seconds 60; classtype:attempted-admin; sid:2004004; rev:1;)
alert tcp $HOME_NET 21 -> $EXTERNAL_NET any (msg:"FTP multiple 530 Authentication Failure responses - possible brute-force"; flow:to_client,established; content:"530 "; nocase; threshold:type both, track by_dst, count 5, seconds 60; classtype:attempted-admin; sid:2004005; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET 21 (msg:"FTP Anonymous login attempt (USER/PASS anonymous)"; flow:to_server,established; content:"USER anonymous"; nocase; classtype:policy-violation; sid:2004006; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET 21 (msg:"FTP Anonymous login attempt (PASS anonymous)"; flow:to_server,established; content:"PASS anonymous"; nocase; classtype:policy-violation; sid:2004007; rev:1;)

#Détection Brute Force SMB
alert tcp any any -> $HOME_NET 445 (msg:"ALERTE [Brute Force SMB]: Tentative de Force Brute NTLM detectee !"; flow:to_server; content:"NTLMSSP"; threshold:type threshold, track by_src, count 30, seconds 5; sid:1100005; rev:1;)
alert tcp any any -> $HOME_NET 445 (msg:"ALERTE [Brute Force SMB]: Tentative de connexion NTLM/SMB - Echec detectee (Session Setup)"; flow:to_server; content:"|74 00 00 00 00 00 00 00|"; threshold:type threshold, track by_src, count 30, seconds 5; sid:1100006; rev:1;)
alert tcp $EXTERNAL_NET any -> $HOME_NET 445 (msg:"SMB Potential brute-force/scan - many SYNs to 445"; flags:S; threshold:type both, track by_src, count 20, seconds 60; classtype:network-scan; sid:140000001; rev:1;) 
alert tcp $HOME_NET 445 -> $EXTERNAL_NET any (msg:"ALERTE [Brute Force SMB]: Echec d'authentification repete (STATUS_LOGON_FAILURE)"; flow:to_client,established; content:"|6D 00 00 C0|"; offset:4; depth:4; threshold:type threshold, track by_src, count 30, seconds 5; sid:1100009; rev:1;)
alert tcp $HOME_NET 445 -> $EXTERNAL_NET any (msg:"ALERTE [Brute Force SMB]: Reponse d'echec de Session (SMBv1/NT Status) detectee"; flow:to_client,established; content:"|FF 53 4D 42|"; offset:4; depth:4; content:"|6D 00 00 C0|"; distance:0; threshold:type threshold, track by_src, count 30, seconds 5; sid:1100010; rev:1;)
alert tcp $HOME_NET 445 -> $EXTERNAL_NET any (msg:"ALERTE [Brute Force SMB]: Reponse d'echec de Session (TRES LARGE)"; flow:to_client,established; content:"|FF 53 4D 42|"; offset:4; depth:4; content:"|6D 00 00 C0|"; distance:1; within:50; threshold:type threshold, track by_src, count 30, seconds 5; sid:1100011; rev:2;)
