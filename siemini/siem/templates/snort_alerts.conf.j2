input {
  file {
    path => "/var/log/snort/snort.alert.fast"    
    start_position => "beginning"
  }
}
filter {
  mutate {
    add_field => {
      "[event][dataset]"   => "snort.alert"
      "[event][module]"    => "snort"
      "[observer][vendor]" => "Snort"
      "[event][kind]"      => "alert"
      "[event][category]"  => "intrusion_detection"
    }
  }

  grok {
    match => {
      "message" => [
        # Example fast line:
        # 10/23-21:05:30.000000  [**] [1:999999:1] SIEM TEST ALERT [**] [Classification: Misc activity] [Priority: 2] {TCP} 10.0.0.1:12345 -> 10.0.0.2:80
        "^%{MONTHNUM:snort.mm}/%{MONTHDAY:snort.dd}-%{TIME:snort.time}\s+"                                     # ts
        "\[\*\*\]\s+\[%{NUMBER:snort.gid:int}:%{NUMBER:snort.sid:int}:%{NUMBER:snort.rev:int}\]\s+"           # [**] [gid:sid:rev]
        "%{DATA:[rule][name]}\s+\[\*\*\]\s+\[Classification:\s*%{DATA:[rule][category]}\]\s+"                  # msg + [**] + Classification
        "\[Priority:\s*%{NUMBER:[event][severity]:int}\]\s+\{\s*%{WORD:[network][transport]}\s*\}\s+"         # Priority + {PROTO}
        "%{IP:[source][ip]}:%{NUMBER:[source][port]:int}\s+->\s+%{IP:[destination][ip]}:%{NUMBER:[destination][port]:int}$"
      ]
    }
    # keep message only on failure for troubleshooting
    tag_on_failure => ["_grokparsefailure_snort"]
  }

  mutate {
    add_field => { "[rule][id]" => "%{[snort][gid]}:%{[snort][sid]}:%{[snort][rev]}" }
    lowercase  => [ "[network][transport]" ]
    add_field  => { "snort.compact_ts" => "%{[snort][mm]}/%{[snort][dd]}-%{[snort][time]}" }
  }

  date {
    match    => [ "snort.compact_ts", "MM/dd-HH:mm:ss.SSSSSS", "MM/dd-HH:mm:ss.SSS" ]
    timezone => "America/Toronto"
    target   => "@timestamp"
  }

  geoip { source => "[source][ip]" target => "[source][geo]" }

  mutate { remove_field => ["snort.mm","snort.dd","snort.time","snort.compact_ts"] }
}

output {
  elasticsearch {
    hosts => ["https://localhost:9200"]
    user  => "elastic"
    password => "ELASTIC_PASSWORD"               
    ssl_enabled => true
    ssl_certificate_authorities => "/opt/elasticsearch/config/certs/http_ca.crt"
    index => "snort-alerts-%{+YYYY.MM.dd}"
  }

  stdout { codec => rubydebug }
}
