---
- name: Check if syslog-ng repo list exists
  ansible.builtin.stat:
    path: "{{ syslogng_list }}"
  register: syslogng_list_stat

- name: Install syslog-ng repo (idempotent)
  when: not syslogng_list_stat.stat.exists
  become: true
  block:
    - name: Download syslog-ng repo key (ASCII)
      ansible.builtin.get_url:
        url: https://ose-repo.syslog-ng.com/apt/syslog-ng-ose-pub.asc
        dest: /tmp/syslog-ng-ose.asc
        mode: '0644'

    - name: Convert syslog-ng key to dearmored keyring
      ansible.builtin.command:
        cmd: "gpg --dearmor -o {{ syslogng_keyring }} /tmp/syslog-ng-ose.asc"
      args:
        creates: "{{ syslogng_keyring }}"

    - name: Add syslog-ng APT repo
      ansible.builtin.copy:
        dest: "{{ syslogng_list }}"
        content: |
          deb [signed-by={{ syslogng_keyring }}] https://ose-repo.syslog-ng.com/apt/ stable ubuntu-jammy
        owner: root
        group: root
        mode: '0644'

    - name: Update package
      ansible.builtin.package:
        update_cache: yes

- name: Install package dependencies
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  with_items: "{{ apt_dependencies }}"

- name: Download and install nvm
  shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"

- name: Source nvm in current shell
  shell: . "{{ ansible_env.HOME }}/.nvm/nvm.sh"
  args:
    executable: /bin/bash

- name: Install Node.js v22
  shell: |
    . "{{ ansible_env.HOME }}/.nvm/nvm.sh"
    nvm install 22
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/versions/node/v22.20.0"

- name: Verify Node.js version
  shell: |
    . "{{ ansible_env.HOME }}/.nvm/nvm.sh"
    node -v
  register: node_version

- debug:
    msg: "Node.js version installed: {{ node_version.stdout }}"

- name: Verify npm version
  shell: |
    . "{{ ansible_env.HOME }}/.nvm/nvm.sh"
    npm -v
  register: npm_version

- debug:
    msg: "NPM version installed: {{ npm_version.stdout }}"

